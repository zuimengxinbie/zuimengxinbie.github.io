---
title: promiseåˆè¯†
date: 2022-01-21 00:00:00
sidebar: auto
sticky: false
permalink: /pages/promise211021/
categories:
  - æŠ€æœ¯
tags:
  - promise
---

<p align="center">
  <img width="500" src="https://p18.qhimg.com/dmfd/2560_1440_/t0120fcf2ecc6026634.jpg"/>
</p>


> å¾…å®Œå–„ï¼Œæ„Ÿè°¢æŒ‡æ•™ ğŸŒ¹ğŸŒ¹ğŸŒ¹
>
> <!-- more -->

## promiseåˆè¯†

- å›è°ƒå‡½æ•°åˆ†ç±»

  - åŒæ­¥å›è°ƒ

    ç†è§£ï¼š ç«‹å³æ‰§è¡Œï¼Œå®Œå…¨æ‰§è¡Œå®Œäº†æ‰ç»“æŸï¼Œä¸ä¼šæ”¾å…¥å›è°ƒé˜Ÿåˆ—ä¸­

    ä¾‹å­ï¼š æ•°ç»„éå†

  - å¼‚æ­¥å›è°ƒ

    ç†è§£ï¼šä¸ä¼šç«‹å³æ‰§è¡Œï¼Œä¼šæ”¾å…¥å›è°ƒé˜Ÿåˆ—ä¸­æ¥æ‰§è¡Œ

    ä¾‹å­ï¼šå®šæ—¶å™¨å›è°ƒ / ajaxå›è°ƒ / Promiseçš„æˆåŠŸ | å¤±è´¥çš„å›è°ƒ

- erroråˆ†ç±»

  - é”™è¯¯çš„ç±»å‹

    1. Error: æ‰€æœ‰é”™è¯¯çš„çˆ¶ç±»å‹
  
    2. ReferenceError:  å¼•ç”¨çš„å˜é‡ä¸å­˜åœ¨
  
    3. TypeError: æ•°æ®ç±»å‹ä¸æ­£ç¡®

    4. RangeError: æ•°æ®å€¼ä¸åœ¨å…¶æ‰€å…è®¸çš„èŒƒå›´å†…

    5. SyntaxError: è¯­æ³•é”™è¯¯

    6. URLErrorï¼š URLç›¸å…³å‡½æ•°çš„å‚æ•°ä¸æ­£ç¡®æŠ›å‡ºçš„é”™è¯¯

    7. EvalErrorï¼š evalå‡½æ•°æ²¡æœ‰è¢«æ­£ç¡®æ‰§è¡Œæ—¶

    8. **[`InternalError`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/InternalError)** ï¼šå¼•æ“æŠ¥é”™

       ```javascript
       eveal() å‡½æ•°
       å°†å­—ç¬¦ä¸²è½¬ä¸º js è¯­å¥ æ‰§è¡Œ
       
       // æ¡ˆä¾‹
       eval("x=10;y=20;document.write(x*y)");
       document.write("<br>" + eval("2+2"));
       document.write("<br>" + eval(x+17));
       
       // ç»“æœ
       200
       4
       27
       ```
  
       ![img](https://staticqn.qizuang.com/custom/20220517/FjC0R2QoLF2DMfZilJGAJcDcJmKb)
  
  - é”™è¯¯å¤„ç†
  
    æ•è·é”™è¯¯ï¼š try ... catch
  
    æŠ›å‡ºé”™è¯¯ï¼š throw error
  
    > [å¦‚æœå°† throw ä¸ try å’Œcatch ä¸€èµ·ä½¿ç”¨ï¼Œ é‚£ä¹ˆæ‚¨èƒ½å¤Ÿæ§åˆ¶ç¨‹åºæµï¼Œ å¹¶ç”Ÿæˆ**è‡ªå®šä¹‰çš„é”™è¯¯æ¶ˆæ¯**](https://www.runoob.com/try/try.php?filename=tryjs_throw_error)
  
  - é”™è¯¯å¯¹è±¡ 
  
    messageå±æ€§ï¼š é”™è¯¯ç›¸å…³ä¿¡æ¯
  
    stackå±æ€§ï¼š å‡½æ•°è°ƒç”¨æ ˆè®°å½•ä¿¡æ¯

- ä¸ºä»€ä¹ˆè¦ç”¨Promise

  1. æŒ‡å®šå›è°ƒå‡½æ•°çš„æ–¹å¼æ›´åŠ çµæ´»

     - æ—§çš„ï¼š å¿…é¡»åœ¨å¯åŠ¨å¼‚æ­¥ä»»åŠ¡å‰
     - promise: å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ =ã€‹ è¿”å›promiseå¯¹è±¡ =ã€‹ç»™promiseå¯¹è±¡ç»‘å®šå›è°ƒå‡½æ•°ï¼ˆç”šè‡³å¯ä»¥åœ¨å¼‚æ­¥ä»»åŠ¡ç»“æŸåæŒ‡å®šï¼‰

  2. æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œå¯ä»¥è§£å†³å›è°ƒåœ°ç‹±é—®é¢˜

     - ä»€ä¹ˆæ˜¯å›è°ƒåœ°ç‹±ï¼Ÿ

       > æ ‡å¿—ï¼š **åµŒå¥—**ï¼Œcallback
       >
       >  å›è°ƒå‡½æ•°**åµŒå¥—**è°ƒç”¨ï¼Œå¤–éƒ¨å›è°ƒå‡½æ•°å¼‚æ­¥æ‰§è¡Œçš„ç»“æœæ˜¯åµŒå¥—çš„å›è°ƒå‡½æ•°æ‰§è¡Œçš„æ¡ä»¶

     - å›è°ƒå‡½æ•°çš„ç¼ºç‚¹ï¼Ÿ ä¸ä¾¿äºé˜…è¯» / ä¸ä¾¿äºå¼‚å¸¸å¤„ç†

     - è§£å†³æ–¹æ¡ˆï¼Ÿ promiseé“¾å¼è°ƒç”¨

       > thençš„è¿”å›ä¾æ—§è¿˜æ˜¯promiseå¯¹è±¡ï¼Œè½»æ¾è§£å†³

       ```
       const p = new Promise((resolve, reject)=>{})
       p.then(value=>{},reason=>{}).then().then() ...
       ```

     - ç»ˆæè§£å†³æ–¹æ¡ˆï¼Ÿ async / await

       ```javascript
       async function request() {
       	try {
       		const result = await doSomething()
       		const newResult = await doSomethingElse(result)
       		const finalResult = await doThirdThing(new Result)
       		console.log('result:'+ finalResult)
       	} catch(error) {
       		failureCallback(error)
       	}
       }
       ```

- PromiseAPI

  ![img](https://staticqn.qizuang.com/custom/20220517/Fu_bXAff3RkJe3AWZI6KG5Lpamnp)

  1. Promiseæ„é€ å‡½æ•°

     ```javascript
     æ„é€ å‡½æ•° Promise (excutor) {}
     excutor å‡½æ•°ï¼š åŒæ­¥æ‰§è¡Œ (resolve, reject) => {}
     resolve å‡½æ•°ï¼š å†…éƒ¨å®šä¹‰æˆåŠŸæ—¶æˆ‘ä»¬è°ƒç”¨çš„å‡½æ•° value => {}
     reject å‡½æ•°ï¼š å†…éƒ¨å®šä¹‰å¤±è´¥æ—¶æˆ‘ä»¬è°ƒç”¨çš„å‡½æ•° reason => {}
     ```

     > è¯´æ˜ï¼š excutor ä¼šåœ¨Promise**å†…éƒ¨**ç«‹å³**åŒæ­¥**å›è°ƒï¼Œ**å¼‚æ­¥**æ“ä½œåœ¨æ‰§è¡Œå™¨**ä¸­**æ‰§è¡Œ

  2. Promise.prototype.then æ–¹æ³•

     ```
     (onResolved, onRejected) => {
     	onResolvedå‡½æ•°ï¼š æˆåŠŸçš„å›è°ƒå‡½æ•° (value) => {}
     	onRejectedå‡½æ•°ï¼š å¤±è´¥çš„å›è°ƒå‡½æ•° (reason) => {}
     	è¯´æ˜ï¼š æŒ‡å®šç”¨äºå¾—åˆ°æˆåŠŸvalueçš„æˆåŠŸå›è°ƒå’Œç”¨äºå¾—åˆ°å¤±è´¥reasonçš„å¤±è´¥å›è°ƒè¿”å›ä¸€ä¸ªæ–°çš„promiseå¯¹è±¡
     }
     ```

  3. Promise.prototype.catchæ–¹æ³•

     ```
     (onRejected) => {
     	onRejectedå‡½æ•°ï¼š å¤±è´¥çš„å›è°ƒå‡½æ•°(reason) => {
     		è¯´æ˜ï¼š then()çš„è¯­æ³•ç³–ï¼Œç›¸å½“äºï¼š then(undefined, onRejected)
     	}
     }
     ```

  4. Promise.resolve æ–¹æ³•

     ```
     (value) => {
     	value: æˆåŠŸçš„æ•°æ®æˆ–promiseå¯¹è±¡
     	è¯´æ˜ï¼š è¿”å›ä¸€ä¸ªæˆåŠŸ / å¤±è´¥çš„promise å¯¹è±¡
     }
     ```

  5. Promise.reject æ–¹æ³•

     ```
     (reason) => {
     	reason: å¤±è´¥çš„åŸå› 
     	è¯´æ˜ï¼š è¿”å›ä¸€ä¸ªå¤±è´¥çš„ promise å¯¹è±¡
     }
     ```

  6. Promise.all æ–¹æ³•

     > è¿”å›æ•°ç»„ï¼Œ ç»“æœé›†åˆ

     ```
     (promises) = >{}
     promises: åŒ…æ‹¬nä¸ªpormsie çš„æ•°ç»„
     è¯´æ˜ï¼š è¿”å›ä¸€ä¸ªæ–°çš„promsieï¼Œ åªæœ‰æ‰€æœ‰çš„promiseéƒ½æˆåŠŸæ‰æˆåŠŸï¼Œ åªè¦æœ‰ä¸€ä¸ªå¤±è´¥å°±ç›´æ¥å¤±è´¥
     
     // ç»“æœ
     ['p1', 'p2']
     ```

  7. Promise.allSettled æ–¹æ³•

     > è¿”å›å¯¹è±¡

     ```javascript
     let p1 = new Promise((resolve, reject) => {
         setTimeout(()=>{
             resolve('p1');
         },500)
     })
     let p2 = new Promise((resolve, reject) => {
         setTimeout(()=>{
             resolve('p2');
         },1000)
     })
     let p = Promise.allSettled([p1, p2]).then(res=>{
         console.log(res);
     })
     
     // ç»“æœ
     {
     	[status: 'fulfilled', value: 'p1'],
     	[status: 'fulfilled', vlaue: 'p2']
     }
     ```

  8. Promsie.raceæ–¹æ³•

     ```
     (promise) => {
     	Promises: åŒ…å«nä¸ªpromsie çš„æ•°ç»„
     	è¯´æ˜ï¼š è¿”å›ä¸€ä¸ªæ–°çš„promiseï¼Œç¬¬ä¸€ä¸ªå®Œæˆçš„promiseçš„ç»“æœçŠ¶æ€å°±æ˜¯æœ€ç»ˆçš„ç»“æœçŠ¶æ€
     }
     ```

- å¦‚ä½•æ”¹å˜Promise çš„çŠ¶æ€

  1. resolveï¼ˆvalueï¼‰: å¦‚æœå½“å‰æ˜¯pendding å°±ä¼šå˜æˆ resolved
  2. rejectï¼ˆreasonï¼‰ï¼šå¦‚æœå½“å‰æ˜¯pendding å°±ä¼šå˜ä¸º rejected
  3. æŠ›å‡ºå¼‚å¸¸ï¼š å¦‚æœå½“å‰æ˜¯ pendding å°±ä¼šå˜ä¸ºrejected

- ä¸€ä¸ªpromiseæŒ‡å®šå¤šä¸ªæˆåŠŸ / å¤±è´¥å›è°ƒå‡½æ•°ï¼Œ éƒ½ä¼šè°ƒç”¨å—ï¼Ÿ 

  å½“promise æ”¹å˜å¯¹åº”çŠ¶æ€æ—¶éƒ½ä¼šè°ƒç”¨

- æ”¹å˜promise çŠ¶æ€å’ŒæŒ‡å®šå›è°ƒå‡½æ•°è°å…ˆè°åï¼Ÿ

  1. éƒ½æœ‰å¯èƒ½ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯å…ˆæŒ‡å®šå›è°ƒå†æ”¹å˜çŠ¶æ€ï¼Œä½†ä¹Ÿå¯ä»¥å…ˆæ”¹å˜çŠ¶æ€å†æŒ‡å®šå›è°ƒ
  2. å¦‚ä½•å…ˆæ”¹çŠ¶æ€å†æŒ‡å®šå›è°ƒ
     - æ‰§è¡Œå™¨ä¸­ç›´æ¥è°ƒåŠ¨ resolve() / reject()
     - å»¶è¿Ÿæ›´é•¿æ—¶é—´æ‰è°ƒç”¨ thenï¼ˆï¼‰
  3. ä»€ä¹ˆæ—¶å€™æ‰èƒ½å¾—åˆ°æ•°æ®
     - å¦‚æœå…ˆæŒ‡å®šçš„å›è°ƒï¼Œ é‚£å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå›è°ƒå‡½æ•°å°±ä¼šè°ƒç”¨ï¼Œå¾—åˆ°æ•°æ®
     - å¦‚æœå…ˆæ”¹å˜çŠ¶æ€ï¼Œé‚£å½“æŒ‡å®šå›è°ƒæ—¶ï¼Œå›è°ƒå‡½æ•°å°±ä¼šè°ƒç”¨ï¼Œ å¾—åˆ°æ•°æ®

- promise.then() è¿”å›çš„æ–°promise çš„ç»“æœçŠ¶æ€ç”±ä»€ä¹ˆå†³å®š?

  - ç®€å•è¡¨è¾¾ï¼š ç”±thenï¼ˆï¼‰æŒ‡å®šçš„å›è°ƒå‡½æ•°æ‰§è¡Œçš„ç»“æœå†³å®š

  - **è¯¦ç»†è¡¨è¾¾**

    1. å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œ æ–°promise å˜ä¸º rejectedï¼Œ reasonä¸º æŠ›å‡ºçš„å¼‚å¸¸

    2. å¦‚æœè¿”å›çš„æ˜¯épromise çš„ä»»æ„å€¼ï¼Œæ–°promise å˜ä¸º resolved, value ä¸ºè¿”å›çš„å€¼

    3. å¦‚æœè¿”å›çš„æ˜¯å¦ä¸€ä¸ªæ–° promiseï¼Œ æ­¤promiseçš„ç»“æœ å°±ä¼šæˆä¸ºæ–°promiseçš„ç»“æœ

       ![img](https://staticqn.qizuang.com/custom/20220517/Frthj1p7J5eNzxKvzlFoHxlfll1Y)

- promise å¦‚ä½•ä¸²è”å¤šä¸ªæ“ä½œä»»åŠ¡

  1. promise çš„thenï¼ˆï¼‰ è¿”å›ä¸€ä¸ªæ–°çš„promise, å¯ä»¥å¼€æˆ thenï¼ˆï¼‰çš„é“¾å¼è°ƒç”¨
  2. é€šè¿‡ thençš„é“¾å¼è°ƒç”¨ä¸²è”å¤šä¸ªåŒæ­¥ / å¼‚æ­¥ä»»åŠ¡

- promise **å¼‚å¸¸ç©¿é€**

  - åœºæ™¯

    å½“æ—¶ç”¨promise çš„then é“¾å¼è°ƒç”¨æ—¶ï¼Œå¯ä»¥åœ¨æœ€åæŒ‡å®šå¤±è´¥çš„å›è°ƒ

  - å®ç°

    å‰é¢ä»»ä½•æ“ä½œå‡ºäº†å¼‚å¸¸ï¼Œéƒ½ä¼šä¼ åˆ°æœ€åå¤±è´¥çš„å›è°ƒä¸­å¤„ç†

- ä¸­æ–­promiseé“¾

  > åœ¨å›è°ƒå‡½æ•°ä¸­è¿”å›ä¸€ä¸ª peddingçŠ¶æ€çš„ promiseå¯¹è±¡

  ```
  new Promise ((reject, reject) => {
  	reject(1)
  }).then().then().then(
  	return new Promsie(() => {})
  )
  ```

## è‡ªå®šä¹‰ï¼ˆæ‰‹å†™ï¼‰Promise

```javascript
(function (window){
    function Promise(excutor) {
        const self = this
        // åˆå§‹åŒ–
        self.status = "pending"
        self.data = undefined
        self.callbacks = []
        function resolve(value) {
            if(self.status !== 'pending') {
                return
            }
            self.status = 'resolved'
            self.data = value
            if(self.callbacks.length>0){
                setTimeout(() => {
                    self.callbacks.forEach(obj => {
                        obj.onResolved(value)
                    })
                })
            }
        }
        function reject(reason) {
            if(self.status !== 'pending') {
                return
            }
            self.staus = 'rejected'
            self.data = reason
            setTimeout(() => {
                obj.onRejected(reason)
            })
        }
        try {
            excutor(resolve, reject)
        } catch (error) {
            reject(error)
        }
        
        // then
        Promise.prototype.then = function (onResolved, onRejected) {
            const self = this
            onResolved = typeof onResolved === 'function' ? onResolved : value =>value
            onRejected = typeof onRejected === 'function' ? onRejected : reason => {throw reason}
            return new Promise ((resolve, reject) => {
                function handle(callback) {
                    try {
                        const x = callback(self.data)
                        if(x instanceof Promise) {
                            x.then(resolve, reject)
                        } else {
                            resolve(x)
                        }
                    } catch (error) {
                        reject(error)
                    }
                }
                if(self.status === 'resolved') {
                    setTimeout(() => {
                        handle(onResolved)
                    })
                } else if (self.status === 'rejected') {
                    setTimeout(() => {
                        handle(onRejected)
                    })
                } else {
                    self.callbacks.push({
                        onResolved(value) {
                            handle(onResolved)
                        },
                        onRejected(reason) {
                            handle(onRejected)
                        }
                    })
                }
            })
        }
        
        // catch
        Promise.prototype.catch = function (onRejected) {
            return this.then(null, onRejected)
        }
        
        // resolve
        Promise.resolve = function(value) {
            return new Promise((resolve, reject) => {
                if(value instanceof Promise) {
                    value.then(resolve, reject)
                } else {
                    resolve(value)
                }
            })
        }
        
        // reject
        Promise.reject = function(reason) {
            return new Promise((resolve, reject) => {
                reject(reason)
            })
        }
        
        // all
        Promise.all = function(promises) {
            return new Promise((resolve, reject) => {
                let resolvedCount = 0
                const promisesLength = promises.length
                const values = new Array(promisesLength)
                for(let i=0; i<promisesLength; i++) {
                    Promise.resolve(promises[i]).then(
                    	value => {
                            values[i] = value
                            resolvedCount ++
                            if(resolvedCount === promisesLength) {
                                resolve(values)
                            }
                        },
                        reason => {
                            reject(reason)
                        }
                    )
                }
            })
        }
        
        // race
        Promise.race = function(promises) {
            return new Promise((resonlve, reject) => {
                for(let i=0; i<promises.length; i++) {
                    Promsie.resolve(promises[i]).then(
                    	(value) => {
                            resolve(value)
                        },
                        (reason) => {
                            reject(reason)
                        }
                    )
                }
            })
        }
    }
})
```

## async ä¸ await

- async å‡½æ•°

  - å‡½æ•°çš„è¿”å›å€¼ä¸ºpromiseå¯¹è±¡
  - promiseå¯¹è±¡çš„ç»“æœç”± async å‡½æ•°æ‰§è¡Œçš„è¿”å›å€¼å†³å®š

  ![img](https://staticqn.qizuang.com/custom/20220517/FgmvtKPLuFhWyBQUOZjYbh8in1wx)

- await è¡¨è¾¾å¼

  - await å³ä¾§çš„è¡¨è¾¾å¼ä¸€èˆ¬ä¸ºpromise å¯¹è±¡ï¼Œ ä½†ä¹Ÿå¯ä»¥æ˜¯åˆ«çš„å€¼
  - å¦‚æœè¡¨è¾¾å¼æ˜¯promiseå¯¹è±¡ï¼Œawait è¿”å›çš„æ˜¯promiseæˆåŠŸçš„å€¼
  - å¦‚æœè¡¨è¾¾å¼æ˜¯å…¶ä»–å€¼ï¼Œç›´æ¥å°†æ­¤å€¼ä½œä¸ºawaitçš„è¿”å›å€¼

- æ³¨æ„

  - await å¿…é¡»å†™åœ¨ async å‡½æ•°ä¸­ï¼Œä½† async å‡½æ•°ä¸­å¯ä»¥æ²¡æœ‰ await
  - å¦‚æœ await çš„promiseå¤±è´¥äº†ï¼Œ å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦é€šè¿‡ try...catch æ•è·å¤„ç†
  - å¤šä¸ªawait å¯ä»¥ç”¨ä¸€ä¸ªcatchæ¥æ”¶ï¼Œ **å¼‚å¸¸ç©¿é€**åœ¨è¿™é‡Œä¹Ÿå¥½ä½¿

## JSå¼‚æ­¥ å®é˜Ÿåˆ— / å¾®é˜Ÿåˆ—

1. JSä¸­ç”¨æ¥å­˜å‚¨å¾…æ‰§è¡Œå›è°ƒå‡½æ•°çš„é˜Ÿåˆ—åŒ…å« 2ä¸ª ä¸åŒç‰¹å®šçš„åˆ—é˜Ÿ

2. å®é˜Ÿåˆ—

   - å®šæ—¶å™¨å›è°ƒ
   - DOMäº‹ä»¶å›è°ƒ
   - ajax å›è°ƒ
   - æ–‡ä»¶æ“ä½œ

3. å¾®é˜Ÿåˆ—

   - promiseçš„å›è°ƒ
   - MutationObserver ç›‘å¬DOMå¯¹è±¡çš„å˜åŒ– 

4. jsæ‰§è¡Œæ—¶ä¼šåŒºåˆ«è¿™2ä¸ªé˜Ÿåˆ—

   - jså¼•æ“é¦–å…ˆå¿…é¡»å…ˆæ‰§è¡Œæ‰€æœ‰çš„åˆå§‹åŒ–åŒæ­¥ä»»åŠ¡ä»£ç 

   - æ¯æ¬¡å‡†å¤‡å–å‡ºç¬¬ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œå‰ï¼Œéƒ½è¦å°†æ‰€æœ‰çš„å¾®ä»»åŠ¡ä¸€ä¸ªä¸€ä¸ªå–å‡ºæ¥æ‰§è¡Œ

     ![img](https://staticqn.qizuang.com/custom/20220517/Fh3j7rgJrqloUHmYbW4UUiFfkhib)

5. [æ¡ˆä¾‹](https://www.jianshu.com/p/334b0e40b4dd)

